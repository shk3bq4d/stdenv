#!/usr/bin/env bash
# /* ex: set filetype=sh fenc=utf-8 expandtab ts=4 sw=4 : */

set -euo pipefail

<<<<<<< HEAD
cmctl_version=2.0.0

sudo -n /bin/true 2>/dev/null && sudo -K # relinquish session kubectl, other untrusted binaries
cmctl_version=2.0.0

BIN="$HOME/bin/cmctl-$cmctl_version"

# https://kubernetes.io/docs/tasks/tools/install-kubectl/
# curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
if [[ ! -f "$BIN" ]]; then
    if [[ ! -t 1 ]]; then
        [[ $# -gt 1 ]] && [[ "$1" == "completion" ]] && exit 1
        >&2 echo "FATAL: no tty and no such file $BIN when calling with args $@"
        exit 1
    fi
    echo -n "$BIN doesn't exist. Would you like to download it? (yN): "
    read _read
    echo # read
    case "${_read,,}" in \
    y|Y|yes)
        true
        ;;
    *)
        exit 1
        ;;
    esac
    test -d ~/.tmp || mkdir ~/.tmp
    cd ~/.tmp
    curl -sLO "https://github.com/cert-manager/cmctl/releases/download/v${cmctl_version}/cmctl_linux_amd64"
    mv -f ~/.tmp/cmctl_linux_amd64 $BIN
    chmod u+x $BIN
fi

~/bin/cmctl-$cmctl_version "$@"
exit $?
